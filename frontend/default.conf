# ----- Rate Limiting -----
# 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=10r/s;

# Burst protection (optional)
# users can burst up to 20 requests but are delayed
limit_req_zone $binary_remote_addr zone=burst_per_ip:10m rate=20r/s;

# ----- Allowlist (optional) -----
# Example: allow only Israel or your office IPs (comment out if unused)
# allow 1.2.3.4;
# deny all;

# ----- Bot detection -----
# Block common bad bots and scanners
map $http_user_agent $is_bad_bot {
    default 0;

    "~*curl"                      1;
    "~*wget"                      1;
    "~*nikto"                     1;
    "~*sqlmap"                    1;
    "~*nessus"                    1;
    "~*scanner"                   1;
    "~*DirBuster"                 1;
    "~*WPScan"                    1;
    "~*acunetix"                  1;
    "~*httpclient"                1;
}

server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Block WordPress scanner paths
    location ~* ^/(wp-admin|wp-includes|wp-content|xmlrpc\.php|blog/|cms/|2018/|shop/|test/|wp2/) {
        return 404;
    }

    # Block PHP execution attempts
    location ~* \.php$ {
        return 404;
    }

    # Rate limiting (applies to all requests)
    limit_req zone=req_per_ip burst=20 nodelay;
    limit_req zone=burst_per_ip burst=40;

    # Block bad bots
    if ($is_bad_bot) {
        return 403;
    }

    # Main SPA rule
    location / {
        try_files $uri $uri/ /index.html;
    }
}
